let iam_roles = Resources.*[ Type == 'AWS::IAM::Role' ]
let iam_users = Resources.*[ Type == 'AWS::IAM::User' ]
let iam_groups = Resources.*[ Type == 'AWS::IAM::Group' ]

rule IAM_Role_Policies when %iam_roles !empty {
    when %iam_roles.Properties.Policies exists {
        %iam_roles.Properties.Policies is_list
        !%iam_roles.Properties.Policies[*] IN ['AmazonKendraFullAccess','AmazonSageMakerFullAccess','AWSLambdaReplicatorInternal','AmazonEC2ContainerServiceEventsRole','AmazonElasticMapReduceFullAccess','AWSDeepRacerServiceRolePolicy','AWSCodeDeployRoleForECS','NeptuneConsoleFullAccess','NeptuneFullAccess','AWSOpsWorksRole','AWSBatchFullAccess','AmazonApplicationWizardFullaccess','ServerMigrationServiceRole','AmazonBraketFullAccess','AmazonLexFullAccess','AWSDataPipelineRole','AWSMarketplaceImageBuildFullAccess','PowerUserAccess','AWSTransferConsoleFullAccess','AWSLambdaFullAccess','AmazonElasticFileSystemServiceRolePolicy','AmazonEventBridgeFullAccess','AWSServiceRoleForSMS','AmazonEMRServicePolicy_v2','AmazonECS_FullAccess','BatchServiceRolePolicy','AmazonDynamoDBFullAccesswithDataPipeline','AWSCodePipeline_FullAccess','AWSThinkboxDeadlineSpotEventPluginAdminPolicy','AdministratorAccess-Amplify','AWSIoTDeviceDefenderEnableIoTLoggingMitigationAction','AmazonHealthLakeFullAccess','AWSEC2FleetServiceRolePolicy','AWSBackupAdminPolicy','AWSApplicationMigrationEC2Access','ApplicationDiscoveryServiceContinuousExportServiceRolePolicy','CloudFormationStackSetsOrgMemberServiceRolePolicy','AWSServiceCatalogAdminFullAccess','AmazonPersonalizeFullAccess','AWSIoTDeviceTesterForGreengrassFullAccess','SystemAdministrator','AWSStepFunctionsConsoleFullAccess','AWSOpsWorks_FullAccess','AWSMarketplaceFullAccess','AWSConfigMultiAccountSetupPolicy','AutoScalingServiceRolePolicy','AmazonFraudDetectorFullAccessPolicy','AWSIoTDeviceTesterForFreeRTOSFullAccess','AWSOpsWorksRegisterCLI','AWSServiceRoleForGammaInternalAmazonEKSNodegroup','DatabaseAdministrator','AWSCloudTrailFullAccess','NetworkAdministrator','AdministratorAccess-AWSElasticBeanstalk','AWSMarketplaceSellerProductsFullAccess','AWSOpsWorksFullAccess','AWSCodeDeployRoleForECSLimited','AmazonEC2SpotFleetRole','AWSCodeStarServiceRole','AWSElasticBeanstalkFullAccess','AWSTransferFullAccess','AWSEC2SpotFleetServiceRolePolicy','AWSElasticBeanstalkManagedUpdatesServiceRolePolicy','CloudWatchSyntheticsFullAccess','AWSB9InternalServicePolicy','AmazonESCognitoAccess','AWSDataPipeline_PowerUser','AmazonInspectorFullAccess','AWSControlTowerServiceRolePolicy','EC2FleetTimeShiftableServiceRolePolicy','AmazonKinesisAnalyticsFullAccess','IAMFullAccess','AWSElasticBeanstalkRoleCore','AWSElasticBeanstalkService','AmazonSSMServiceRolePolicy','DataScientist','AWSElementalMediaConvertFullAccess','AwsGlueDataBrewFullAccessPolicy','AWSServiceRoleForImageBuilder','AmazonForecastFullAccess','AWSIoTSiteWiseConsoleFullAccess','AmazonMechanicalTurkCrowdFullAccess','AmazonElasticTranscoder_FullAccess','AmazonAugmentedAIFullAccess','AWSDataSyncFullAccess','AmazonSageMakerAdmin-ServiceCatalogProductsServiceRolePolicy','AWSGlueConsoleSageMakerNotebookFullAccess','AmazonLaunchWizardFullaccess','AWSServiceRoleForAmazonEKSNodegroup','AWSDataPipeline_FullAccess','ConfigConformsServiceRolePolicy','AWSOpsWorksRegisterCLI_OnPremises','AWSLambdaReplicator','AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy','AWSImageBuilderFullAccess','AdministratorAccess','AWSLicenseManagerMasterAccountRolePolicy','AWSDeepRacerCloudFormationAccessPolicy','ServerMigration_ServiceRole','AWSOpsWorksCMServiceRole','AmazonDynamoDBFullAccess','AWSConfigRemediationServiceRolePolicy','AWSBackupOperatorPolicy','AWSMarketplaceSellerFullAccess','AWSCodePipelineFullAccess','AmazonAppStreamFullAccess','AWSSSOServiceRolePolicy','AWSEC2SpotServiceRolePolicy','AmazonLookoutMetricsFullAccess','AWSApplicationAutoscalingRDSClusterPolicy','AmazonLookoutEquipmentFullAccess','AWSBatchServiceRole','AWSSystemsManagerChangeManagementServicePolicy','AWSRoboMakerServiceRolePolicy','AWSBackupOperatorAccess','AWSRoboMakerServicePolicy','AWSApplicationMigrationServiceRolePolicy','AWSSSOMasterAccountAdministrator','AmazonElasticMapReduceRole','AWSGrafanaAccountAdministrator','CloudWatchEventsFullAccess','AmazonEC2SpotFleetTaggingRole','ServerMigrationServiceLaunchRole','AWSGlueConsoleFullAccess','AWSThinkboxDeadlineResourceTrackerAdminPolicy','AWSPanoramaServiceRolePolicy','AmazonMSKFullAccess','AWSBudgetsActionsWithAWSResourceControlAccess','AWSProtonFullAccess','AWSIQPermissionServiceRolePolicy','AmazonSageMakerEdgeDeviceFleetPolicy','AmazonLaunchWizard_Fullaccess','AmazonConnectFullAccess','AmazonEC2ContainerServiceFullAccess','AWSCloud9ServiceRolePolicy','AmazonWorkMailFullAccess','AmazonAugmentedAIIntegratedAPIAccess','AmazonEMRFullAccessPolicy_v2','AWSThinkboxAWSPortalAdminPolicy','AWSLambda_FullAccess','AWSBackupFullAccess','AWSAppSyncAdministrator','AWSDeepLensServiceRolePolicy','AWSCloudTrail_FullAccess'] <<Managed IAM Policy has possible privilege escalation>>
        !%iam_roles.Properties.Policies[*] IN ['ServiceCatalogAdminReadOnlyAccess','AmazonEverestServicePolicy','AWSLambdaReplicatorInternal','AWSOpsWorksRole','AmazonEC2RolePolicyForApplicationWizard','AmazonApplicationWizardFullaccess','ServerMigrationServiceRole','AWSLambdaFullAccess','AmazonMachineLearningRoleforRedshiftDataSourceV2','AWSBackupAdminPolicy','AmazonMachineLearningRoleforRedshiftDataSource','AWSOpsWorksRegisterCLI','AWSCodeArtifactReadOnlyAccess.json','AWSServiceRoleForGammaInternalAmazonEKSNodegroup','AWSCloudTrailFullAccess','AWSOpsWorksFullAccess','AmazonEC2SpotFleetRole','AWSServiceRoleForCodeGuruProfiler','AWSElasticBeanstalkFullAccess','CheesepuffsServiceRolePolicy','AWSB9InternalServicePolicy','AWSRoboMakerFullAccess','ServiceCatalogEndUserAccess','AmazonMechanicalTurkCrowdFullAccess','AWSServiceRoleForThorInternalDevPolicy','AWSLambdaReadOnlyAccess','AmazonLaunchWizardFullaccess','TagGovernancePolicy','AWSSchemasServiceRolePolicy','AWSElasticBeanstalkReadOnlyAccess','AWSBackupOperatorPolicy','AmazonEC2ReportsAccess','TagPoliciesServiceRolePolicy','AWS_Config_Role','AmazonMechanicalTurkCrowdReadOnlyAccess','AmazonConnectFullAccess','AmazonEC2ContainerServiceFullAccess'] <<Deprecated Managed IAM Policy in use>>
    }
}

rule IAM_User_Policies when %iam_users !empty {
    when %iam_users.Properties.Policies exists {
        %iam_users.Properties.Policies is_list
        !%iam_users.Properties.Policies[*] IN ['AmazonKendraFullAccess','AmazonSageMakerFullAccess','AWSLambdaReplicatorInternal','AmazonEC2ContainerServiceEventsRole','AmazonElasticMapReduceFullAccess','AWSDeepRacerServiceRolePolicy','AWSCodeDeployRoleForECS','NeptuneConsoleFullAccess','NeptuneFullAccess','AWSOpsWorksRole','AWSBatchFullAccess','AmazonApplicationWizardFullaccess','ServerMigrationServiceRole','AmazonBraketFullAccess','AmazonLexFullAccess','AWSDataPipelineRole','AWSMarketplaceImageBuildFullAccess','PowerUserAccess','AWSTransferConsoleFullAccess','AWSLambdaFullAccess','AmazonElasticFileSystemServiceRolePolicy','AmazonEventBridgeFullAccess','AWSServiceRoleForSMS','AmazonEMRServicePolicy_v2','AmazonECS_FullAccess','BatchServiceRolePolicy','AmazonDynamoDBFullAccesswithDataPipeline','AWSCodePipeline_FullAccess','AWSThinkboxDeadlineSpotEventPluginAdminPolicy','AdministratorAccess-Amplify','AWSIoTDeviceDefenderEnableIoTLoggingMitigationAction','AmazonHealthLakeFullAccess','AWSEC2FleetServiceRolePolicy','AWSBackupAdminPolicy','AWSApplicationMigrationEC2Access','ApplicationDiscoveryServiceContinuousExportServiceRolePolicy','CloudFormationStackSetsOrgMemberServiceRolePolicy','AWSServiceCatalogAdminFullAccess','AmazonPersonalizeFullAccess','AWSIoTDeviceTesterForGreengrassFullAccess','SystemAdministrator','AWSStepFunctionsConsoleFullAccess','AWSOpsWorks_FullAccess','AWSMarketplaceFullAccess','AWSConfigMultiAccountSetupPolicy','AutoScalingServiceRolePolicy','AmazonFraudDetectorFullAccessPolicy','AWSIoTDeviceTesterForFreeRTOSFullAccess','AWSOpsWorksRegisterCLI','AWSServiceRoleForGammaInternalAmazonEKSNodegroup','DatabaseAdministrator','AWSCloudTrailFullAccess','NetworkAdministrator','AdministratorAccess-AWSElasticBeanstalk','AWSMarketplaceSellerProductsFullAccess','AWSOpsWorksFullAccess','AWSCodeDeployRoleForECSLimited','AmazonEC2SpotFleetRole','AWSCodeStarServiceRole','AWSElasticBeanstalkFullAccess','AWSTransferFullAccess','AWSEC2SpotFleetServiceRolePolicy','AWSElasticBeanstalkManagedUpdatesServiceRolePolicy','CloudWatchSyntheticsFullAccess','AWSB9InternalServicePolicy','AmazonESCognitoAccess','AWSDataPipeline_PowerUser','AmazonInspectorFullAccess','AWSControlTowerServiceRolePolicy','EC2FleetTimeShiftableServiceRolePolicy','AmazonKinesisAnalyticsFullAccess','IAMFullAccess','AWSElasticBeanstalkRoleCore','AWSElasticBeanstalkService','AmazonSSMServiceRolePolicy','DataScientist','AWSElementalMediaConvertFullAccess','AwsGlueDataBrewFullAccessPolicy','AWSServiceRoleForImageBuilder','AmazonForecastFullAccess','AWSIoTSiteWiseConsoleFullAccess','AmazonMechanicalTurkCrowdFullAccess','AmazonElasticTranscoder_FullAccess','AmazonAugmentedAIFullAccess','AWSDataSyncFullAccess','AmazonSageMakerAdmin-ServiceCatalogProductsServiceRolePolicy','AWSGlueConsoleSageMakerNotebookFullAccess','AmazonLaunchWizardFullaccess','AWSServiceRoleForAmazonEKSNodegroup','AWSDataPipeline_FullAccess','ConfigConformsServiceRolePolicy','AWSOpsWorksRegisterCLI_OnPremises','AWSLambdaReplicator','AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy','AWSImageBuilderFullAccess','AdministratorAccess','AWSLicenseManagerMasterAccountRolePolicy','AWSDeepRacerCloudFormationAccessPolicy','ServerMigration_ServiceRole','AWSOpsWorksCMServiceRole','AmazonDynamoDBFullAccess','AWSConfigRemediationServiceRolePolicy','AWSBackupOperatorPolicy','AWSMarketplaceSellerFullAccess','AWSCodePipelineFullAccess','AmazonAppStreamFullAccess','AWSSSOServiceRolePolicy','AWSEC2SpotServiceRolePolicy','AmazonLookoutMetricsFullAccess','AWSApplicationAutoscalingRDSClusterPolicy','AmazonLookoutEquipmentFullAccess','AWSBatchServiceRole','AWSSystemsManagerChangeManagementServicePolicy','AWSRoboMakerServiceRolePolicy','AWSBackupOperatorAccess','AWSRoboMakerServicePolicy','AWSApplicationMigrationServiceRolePolicy','AWSSSOMasterAccountAdministrator','AmazonElasticMapReduceRole','AWSGrafanaAccountAdministrator','CloudWatchEventsFullAccess','AmazonEC2SpotFleetTaggingRole','ServerMigrationServiceLaunchRole','AWSGlueConsoleFullAccess','AWSThinkboxDeadlineResourceTrackerAdminPolicy','AWSPanoramaServiceRolePolicy','AmazonMSKFullAccess','AWSBudgetsActionsWithAWSResourceControlAccess','AWSProtonFullAccess','AWSIQPermissionServiceRolePolicy','AmazonSageMakerEdgeDeviceFleetPolicy','AmazonLaunchWizard_Fullaccess','AmazonConnectFullAccess','AmazonEC2ContainerServiceFullAccess','AWSCloud9ServiceRolePolicy','AmazonWorkMailFullAccess','AmazonAugmentedAIIntegratedAPIAccess','AmazonEMRFullAccessPolicy_v2','AWSThinkboxAWSPortalAdminPolicy','AWSLambda_FullAccess','AWSBackupFullAccess','AWSAppSyncAdministrator','AWSDeepLensServiceRolePolicy','AWSCloudTrail_FullAccess'] <<Managed IAM Policy has possible privilege escalation>>
        !%iam_users.Properties.Policies[*] IN ['ServiceCatalogAdminReadOnlyAccess','AmazonEverestServicePolicy','AWSLambdaReplicatorInternal','AWSOpsWorksRole','AmazonEC2RolePolicyForApplicationWizard','AmazonApplicationWizardFullaccess','ServerMigrationServiceRole','AWSLambdaFullAccess','AmazonMachineLearningRoleforRedshiftDataSourceV2','AWSBackupAdminPolicy','AmazonMachineLearningRoleforRedshiftDataSource','AWSOpsWorksRegisterCLI','AWSCodeArtifactReadOnlyAccess.json','AWSServiceRoleForGammaInternalAmazonEKSNodegroup','AWSCloudTrailFullAccess','AWSOpsWorksFullAccess','AmazonEC2SpotFleetRole','AWSServiceRoleForCodeGuruProfiler','AWSElasticBeanstalkFullAccess','CheesepuffsServiceRolePolicy','AWSB9InternalServicePolicy','AWSRoboMakerFullAccess','ServiceCatalogEndUserAccess','AmazonMechanicalTurkCrowdFullAccess','AWSServiceRoleForThorInternalDevPolicy','AWSLambdaReadOnlyAccess','AmazonLaunchWizardFullaccess','TagGovernancePolicy','AWSSchemasServiceRolePolicy','AWSElasticBeanstalkReadOnlyAccess','AWSBackupOperatorPolicy','AmazonEC2ReportsAccess','TagPoliciesServiceRolePolicy','AWS_Config_Role','AmazonMechanicalTurkCrowdReadOnlyAccess','AmazonConnectFullAccess','AmazonEC2ContainerServiceFullAccess'] <<Deprecated Managed IAM Policy in use>>
    }
}

rule IAM_Group_Policies when %iam_groups !empty {
    when %iam_groups.Properties.Policies exists {
        %iam_groups.Properties.Policies is_list
        !%iam_groups.Properties.Policies[*] IN ['AmazonKendraFullAccess','AmazonSageMakerFullAccess','AWSLambdaReplicatorInternal','AmazonEC2ContainerServiceEventsRole','AmazonElasticMapReduceFullAccess','AWSDeepRacerServiceRolePolicy','AWSCodeDeployRoleForECS','NeptuneConsoleFullAccess','NeptuneFullAccess','AWSOpsWorksRole','AWSBatchFullAccess','AmazonApplicationWizardFullaccess','ServerMigrationServiceRole','AmazonBraketFullAccess','AmazonLexFullAccess','AWSDataPipelineRole','AWSMarketplaceImageBuildFullAccess','PowerUserAccess','AWSTransferConsoleFullAccess','AWSLambdaFullAccess','AmazonElasticFileSystemServiceRolePolicy','AmazonEventBridgeFullAccess','AWSServiceRoleForSMS','AmazonEMRServicePolicy_v2','AmazonECS_FullAccess','BatchServiceRolePolicy','AmazonDynamoDBFullAccesswithDataPipeline','AWSCodePipeline_FullAccess','AWSThinkboxDeadlineSpotEventPluginAdminPolicy','AdministratorAccess-Amplify','AWSIoTDeviceDefenderEnableIoTLoggingMitigationAction','AmazonHealthLakeFullAccess','AWSEC2FleetServiceRolePolicy','AWSBackupAdminPolicy','AWSApplicationMigrationEC2Access','ApplicationDiscoveryServiceContinuousExportServiceRolePolicy','CloudFormationStackSetsOrgMemberServiceRolePolicy','AWSServiceCatalogAdminFullAccess','AmazonPersonalizeFullAccess','AWSIoTDeviceTesterForGreengrassFullAccess','SystemAdministrator','AWSStepFunctionsConsoleFullAccess','AWSOpsWorks_FullAccess','AWSMarketplaceFullAccess','AWSConfigMultiAccountSetupPolicy','AutoScalingServiceRolePolicy','AmazonFraudDetectorFullAccessPolicy','AWSIoTDeviceTesterForFreeRTOSFullAccess','AWSOpsWorksRegisterCLI','AWSServiceRoleForGammaInternalAmazonEKSNodegroup','DatabaseAdministrator','AWSCloudTrailFullAccess','NetworkAdministrator','AdministratorAccess-AWSElasticBeanstalk','AWSMarketplaceSellerProductsFullAccess','AWSOpsWorksFullAccess','AWSCodeDeployRoleForECSLimited','AmazonEC2SpotFleetRole','AWSCodeStarServiceRole','AWSElasticBeanstalkFullAccess','AWSTransferFullAccess','AWSEC2SpotFleetServiceRolePolicy','AWSElasticBeanstalkManagedUpdatesServiceRolePolicy','CloudWatchSyntheticsFullAccess','AWSB9InternalServicePolicy','AmazonESCognitoAccess','AWSDataPipeline_PowerUser','AmazonInspectorFullAccess','AWSControlTowerServiceRolePolicy','EC2FleetTimeShiftableServiceRolePolicy','AmazonKinesisAnalyticsFullAccess','IAMFullAccess','AWSElasticBeanstalkRoleCore','AWSElasticBeanstalkService','AmazonSSMServiceRolePolicy','DataScientist','AWSElementalMediaConvertFullAccess','AwsGlueDataBrewFullAccessPolicy','AWSServiceRoleForImageBuilder','AmazonForecastFullAccess','AWSIoTSiteWiseConsoleFullAccess','AmazonMechanicalTurkCrowdFullAccess','AmazonElasticTranscoder_FullAccess','AmazonAugmentedAIFullAccess','AWSDataSyncFullAccess','AmazonSageMakerAdmin-ServiceCatalogProductsServiceRolePolicy','AWSGlueConsoleSageMakerNotebookFullAccess','AmazonLaunchWizardFullaccess','AWSServiceRoleForAmazonEKSNodegroup','AWSDataPipeline_FullAccess','ConfigConformsServiceRolePolicy','AWSOpsWorksRegisterCLI_OnPremises','AWSLambdaReplicator','AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy','AWSImageBuilderFullAccess','AdministratorAccess','AWSLicenseManagerMasterAccountRolePolicy','AWSDeepRacerCloudFormationAccessPolicy','ServerMigration_ServiceRole','AWSOpsWorksCMServiceRole','AmazonDynamoDBFullAccess','AWSConfigRemediationServiceRolePolicy','AWSBackupOperatorPolicy','AWSMarketplaceSellerFullAccess','AWSCodePipelineFullAccess','AmazonAppStreamFullAccess','AWSSSOServiceRolePolicy','AWSEC2SpotServiceRolePolicy','AmazonLookoutMetricsFullAccess','AWSApplicationAutoscalingRDSClusterPolicy','AmazonLookoutEquipmentFullAccess','AWSBatchServiceRole','AWSSystemsManagerChangeManagementServicePolicy','AWSRoboMakerServiceRolePolicy','AWSBackupOperatorAccess','AWSRoboMakerServicePolicy','AWSApplicationMigrationServiceRolePolicy','AWSSSOMasterAccountAdministrator','AmazonElasticMapReduceRole','AWSGrafanaAccountAdministrator','CloudWatchEventsFullAccess','AmazonEC2SpotFleetTaggingRole','ServerMigrationServiceLaunchRole','AWSGlueConsoleFullAccess','AWSThinkboxDeadlineResourceTrackerAdminPolicy','AWSPanoramaServiceRolePolicy','AmazonMSKFullAccess','AWSBudgetsActionsWithAWSResourceControlAccess','AWSProtonFullAccess','AWSIQPermissionServiceRolePolicy','AmazonSageMakerEdgeDeviceFleetPolicy','AmazonLaunchWizard_Fullaccess','AmazonConnectFullAccess','AmazonEC2ContainerServiceFullAccess','AWSCloud9ServiceRolePolicy','AmazonWorkMailFullAccess','AmazonAugmentedAIIntegratedAPIAccess','AmazonEMRFullAccessPolicy_v2','AWSThinkboxAWSPortalAdminPolicy','AWSLambda_FullAccess','AWSBackupFullAccess','AWSAppSyncAdministrator','AWSDeepLensServiceRolePolicy','AWSCloudTrail_FullAccess'] <<Managed IAM Policy has possible privilege escalation>>
        !%iam_groups.Properties.Policies[*] IN ['ServiceCatalogAdminReadOnlyAccess','AmazonEverestServicePolicy','AWSLambdaReplicatorInternal','AWSOpsWorksRole','AmazonEC2RolePolicyForApplicationWizard','AmazonApplicationWizardFullaccess','ServerMigrationServiceRole','AWSLambdaFullAccess','AmazonMachineLearningRoleforRedshiftDataSourceV2','AWSBackupAdminPolicy','AmazonMachineLearningRoleforRedshiftDataSource','AWSOpsWorksRegisterCLI','AWSCodeArtifactReadOnlyAccess.json','AWSServiceRoleForGammaInternalAmazonEKSNodegroup','AWSCloudTrailFullAccess','AWSOpsWorksFullAccess','AmazonEC2SpotFleetRole','AWSServiceRoleForCodeGuruProfiler','AWSElasticBeanstalkFullAccess','CheesepuffsServiceRolePolicy','AWSB9InternalServicePolicy','AWSRoboMakerFullAccess','ServiceCatalogEndUserAccess','AmazonMechanicalTurkCrowdFullAccess','AWSServiceRoleForThorInternalDevPolicy','AWSLambdaReadOnlyAccess','AmazonLaunchWizardFullaccess','TagGovernancePolicy','AWSSchemasServiceRolePolicy','AWSElasticBeanstalkReadOnlyAccess','AWSBackupOperatorPolicy','AmazonEC2ReportsAccess','TagPoliciesServiceRolePolicy','AWS_Config_Role','AmazonMechanicalTurkCrowdReadOnlyAccess','AmazonConnectFullAccess','AmazonEC2ContainerServiceFullAccess'] <<Deprecated Managed IAM Policy in use>>
    }
}
