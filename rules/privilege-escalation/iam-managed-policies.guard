let iam_roles = Resources.*[ Type == 'AWS::IAM::Role' ]
let iam_users = Resources.*[ Type == 'AWS::IAM::User' ]
let iam_groups = Resources.*[ Type == 'AWS::IAM::Group' ]

rule IAM_Role_Policies when %iam_roles !empty {
    when %iam_roles.Properties.Policies exists {
        %iam_roles.Properties.Policies is_list
        !%iam_roles.Properties.Policies[*] IN ['arn:aws:iam::aws:policy/AmazonKendraFullAccess','arn:aws:iam::aws:policy/AmazonSageMakerFullAccess','arn:aws:iam::aws:policy/AWSLambdaReplicatorInternal','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceEventsRole','arn:aws:iam::aws:policy/AmazonElasticMapReduceFullAccess','arn:aws:iam::aws:policy/AWSDeepRacerServiceRolePolicy','arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS','arn:aws:iam::aws:policy/NeptuneConsoleFullAccess','arn:aws:iam::aws:policy/NeptuneFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksRole','arn:aws:iam::aws:policy/AWSBatchFullAccess','arn:aws:iam::aws:policy/AmazonApplicationWizardFullaccess','arn:aws:iam::aws:policy/ServerMigrationServiceRole','arn:aws:iam::aws:policy/AmazonBraketFullAccess','arn:aws:iam::aws:policy/AmazonLexFullAccess','arn:aws:iam::aws:policy/AWSDataPipelineRole','arn:aws:iam::aws:policy/AWSMarketplaceImageBuildFullAccess','arn:aws:iam::aws:policy/PowerUserAccess','arn:aws:iam::aws:policy/AWSTransferConsoleFullAccess','arn:aws:iam::aws:policy/AWSLambdaFullAccess','arn:aws:iam::aws:policy/AmazonElasticFileSystemServiceRolePolicy','arn:aws:iam::aws:policy/AmazonEventBridgeFullAccess','arn:aws:iam::aws:policy/AWSServiceRoleForSMS','arn:aws:iam::aws:policy/AmazonEMRServicePolicy_v2','arn:aws:iam::aws:policy/AmazonECS_FullAccess','arn:aws:iam::aws:policy/BatchServiceRolePolicy','arn:aws:iam::aws:policy/AmazonDynamoDBFullAccesswithDataPipeline','arn:aws:iam::aws:policy/AWSCodePipeline_FullAccess','arn:aws:iam::aws:policy/AWSThinkboxDeadlineSpotEventPluginAdminPolicy','arn:aws:iam::aws:policy/AdministratorAccess-Amplify','arn:aws:iam::aws:policy/AWSIoTDeviceDefenderEnableIoTLoggingMitigationAction','arn:aws:iam::aws:policy/AmazonHealthLakeFullAccess','arn:aws:iam::aws:policy/AWSEC2FleetServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupAdminPolicy','arn:aws:iam::aws:policy/AWSApplicationMigrationEC2Access','arn:aws:iam::aws:policy/ApplicationDiscoveryServiceContinuousExportServiceRolePolicy','arn:aws:iam::aws:policy/CloudFormationStackSetsOrgMemberServiceRolePolicy','arn:aws:iam::aws:policy/AWSServiceCatalogAdminFullAccess','arn:aws:iam::aws:policy/AmazonPersonalizeFullAccess','arn:aws:iam::aws:policy/AWSIoTDeviceTesterForGreengrassFullAccess','arn:aws:iam::aws:policy/SystemAdministrator','arn:aws:iam::aws:policy/AWSStepFunctionsConsoleFullAccess','arn:aws:iam::aws:policy/AWSOpsWorks_FullAccess','arn:aws:iam::aws:policy/AWSMarketplaceFullAccess','arn:aws:iam::aws:policy/AWSConfigMultiAccountSetupPolicy','arn:aws:iam::aws:policy/AutoScalingServiceRolePolicy','arn:aws:iam::aws:policy/AmazonFraudDetectorFullAccessPolicy','arn:aws:iam::aws:policy/AWSIoTDeviceTesterForFreeRTOSFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI','arn:aws:iam::aws:policy/AWSServiceRoleForGammaInternalAmazonEKSNodegroup','arn:aws:iam::aws:policy/DatabaseAdministrator','arn:aws:iam::aws:policy/AWSCloudTrailFullAccess','arn:aws:iam::aws:policy/NetworkAdministrator','arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk','arn:aws:iam::aws:policy/AWSMarketplaceSellerProductsFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksFullAccess','arn:aws:iam::aws:policy/AWSCodeDeployRoleForECSLimited','arn:aws:iam::aws:policy/AmazonEC2SpotFleetRole','arn:aws:iam::aws:policy/AWSCodeStarServiceRole','arn:aws:iam::aws:policy/AWSElasticBeanstalkFullAccess','arn:aws:iam::aws:policy/AWSTransferFullAccess','arn:aws:iam::aws:policy/AWSEC2SpotFleetServiceRolePolicy','arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesServiceRolePolicy','arn:aws:iam::aws:policy/CloudWatchSyntheticsFullAccess','arn:aws:iam::aws:policy/AWSB9InternalServicePolicy','arn:aws:iam::aws:policy/AmazonESCognitoAccess','arn:aws:iam::aws:policy/AWSDataPipeline_PowerUser','arn:aws:iam::aws:policy/AmazonInspectorFullAccess','arn:aws:iam::aws:policy/AWSControlTowerServiceRolePolicy','arn:aws:iam::aws:policy/EC2FleetTimeShiftableServiceRolePolicy','arn:aws:iam::aws:policy/AmazonKinesisAnalyticsFullAccess','arn:aws:iam::aws:policy/IAMFullAccess','arn:aws:iam::aws:policy/AWSElasticBeanstalkRoleCore','arn:aws:iam::aws:policy/AWSElasticBeanstalkService','arn:aws:iam::aws:policy/AmazonSSMServiceRolePolicy','arn:aws:iam::aws:policy/DataScientist','arn:aws:iam::aws:policy/AWSElementalMediaConvertFullAccess','arn:aws:iam::aws:policy/AwsGlueDataBrewFullAccessPolicy','arn:aws:iam::aws:policy/AWSServiceRoleForImageBuilder','arn:aws:iam::aws:policy/AmazonForecastFullAccess','arn:aws:iam::aws:policy/AWSIoTSiteWiseConsoleFullAccess','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdFullAccess','arn:aws:iam::aws:policy/AmazonElasticTranscoder_FullAccess','arn:aws:iam::aws:policy/AmazonAugmentedAIFullAccess','arn:aws:iam::aws:policy/AWSDataSyncFullAccess','arn:aws:iam::aws:policy/AmazonSageMakerAdmin-ServiceCatalogProductsServiceRolePolicy','arn:aws:iam::aws:policy/AWSGlueConsoleSageMakerNotebookFullAccess','arn:aws:iam::aws:policy/AmazonLaunchWizardFullaccess','arn:aws:iam::aws:policy/AWSServiceRoleForAmazonEKSNodegroup','arn:aws:iam::aws:policy/AWSDataPipeline_FullAccess','arn:aws:iam::aws:policy/ConfigConformsServiceRolePolicy','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI_OnPremises','arn:aws:iam::aws:policy/AWSLambdaReplicator','arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy','arn:aws:iam::aws:policy/AWSImageBuilderFullAccess','arn:aws:iam::aws:policy/AdministratorAccess','arn:aws:iam::aws:policy/AWSLicenseManagerMasterAccountRolePolicy','arn:aws:iam::aws:policy/AWSDeepRacerCloudFormationAccessPolicy','arn:aws:iam::aws:policy/ServerMigration_ServiceRole','arn:aws:iam::aws:policy/AWSOpsWorksCMServiceRole','arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess','arn:aws:iam::aws:policy/AWSConfigRemediationServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupOperatorPolicy','arn:aws:iam::aws:policy/AWSMarketplaceSellerFullAccess','arn:aws:iam::aws:policy/AWSCodePipelineFullAccess','arn:aws:iam::aws:policy/AmazonAppStreamFullAccess','arn:aws:iam::aws:policy/AWSSSOServiceRolePolicy','arn:aws:iam::aws:policy/AWSEC2SpotServiceRolePolicy','arn:aws:iam::aws:policy/AmazonLookoutMetricsFullAccess','arn:aws:iam::aws:policy/AWSApplicationAutoscalingRDSClusterPolicy','arn:aws:iam::aws:policy/AmazonLookoutEquipmentFullAccess','arn:aws:iam::aws:policy/AWSBatchServiceRole','arn:aws:iam::aws:policy/AWSSystemsManagerChangeManagementServicePolicy','arn:aws:iam::aws:policy/AWSRoboMakerServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupOperatorAccess','arn:aws:iam::aws:policy/AWSRoboMakerServicePolicy','arn:aws:iam::aws:policy/AWSApplicationMigrationServiceRolePolicy','arn:aws:iam::aws:policy/AWSSSOMasterAccountAdministrator','arn:aws:iam::aws:policy/AmazonElasticMapReduceRole','arn:aws:iam::aws:policy/AWSGrafanaAccountAdministrator','arn:aws:iam::aws:policy/CloudWatchEventsFullAccess','arn:aws:iam::aws:policy/AmazonEC2SpotFleetTaggingRole','arn:aws:iam::aws:policy/ServerMigrationServiceLaunchRole','arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess','arn:aws:iam::aws:policy/AWSThinkboxDeadlineResourceTrackerAdminPolicy','arn:aws:iam::aws:policy/AWSPanoramaServiceRolePolicy','arn:aws:iam::aws:policy/AmazonMSKFullAccess','arn:aws:iam::aws:policy/AWSBudgetsActionsWithAWSResourceControlAccess','arn:aws:iam::aws:policy/AWSProtonFullAccess','arn:aws:iam::aws:policy/AWSIQPermissionServiceRolePolicy','arn:aws:iam::aws:policy/AmazonSageMakerEdgeDeviceFleetPolicy','arn:aws:iam::aws:policy/AmazonLaunchWizard_Fullaccess','arn:aws:iam::aws:policy/AmazonConnectFullAccess','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceFullAccess','arn:aws:iam::aws:policy/AWSCloud9ServiceRolePolicy','arn:aws:iam::aws:policy/AmazonWorkMailFullAccess','arn:aws:iam::aws:policy/AmazonAugmentedAIIntegratedAPIAccess','arn:aws:iam::aws:policy/AmazonEMRFullAccessPolicy_v2','arn:aws:iam::aws:policy/AWSThinkboxAWSPortalAdminPolicy','arn:aws:iam::aws:policy/AWSLambda_FullAccess','arn:aws:iam::aws:policy/AWSBackupFullAccess','arn:aws:iam::aws:policy/AWSAppSyncAdministrator','arn:aws:iam::aws:policy/AWSDeepLensServiceRolePolicy','arn:aws:iam::aws:policy/AWSCloudTrail_FullAccess'] <<Managed IAM Policy has possible privilege escalation>>
        !%iam_roles.Properties.Policies[*] IN ['arn:aws:iam::aws:policy/ServiceCatalogAdminReadOnlyAccess','arn:aws:iam::aws:policy/AmazonEverestServicePolicy','arn:aws:iam::aws:policy/AWSLambdaReplicatorInternal','arn:aws:iam::aws:policy/AWSOpsWorksRole','arn:aws:iam::aws:policy/AmazonEC2RolePolicyForApplicationWizard','arn:aws:iam::aws:policy/AmazonApplicationWizardFullaccess','arn:aws:iam::aws:policy/ServerMigrationServiceRole','arn:aws:iam::aws:policy/AWSLambdaFullAccess','arn:aws:iam::aws:policy/AmazonMachineLearningRoleforRedshiftDataSourceV2','arn:aws:iam::aws:policy/AWSBackupAdminPolicy','arn:aws:iam::aws:policy/AmazonMachineLearningRoleforRedshiftDataSource','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI','arn:aws:iam::aws:policy/AWSCodeArtifactReadOnlyAccess.json','arn:aws:iam::aws:policy/AWSServiceRoleForGammaInternalAmazonEKSNodegroup','arn:aws:iam::aws:policy/AWSCloudTrailFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksFullAccess','arn:aws:iam::aws:policy/AmazonEC2SpotFleetRole','arn:aws:iam::aws:policy/AWSServiceRoleForCodeGuruProfiler','arn:aws:iam::aws:policy/AWSElasticBeanstalkFullAccess','arn:aws:iam::aws:policy/CheesepuffsServiceRolePolicy','arn:aws:iam::aws:policy/AWSB9InternalServicePolicy','arn:aws:iam::aws:policy/AWSRoboMakerFullAccess','arn:aws:iam::aws:policy/ServiceCatalogEndUserAccess','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdFullAccess','arn:aws:iam::aws:policy/AWSServiceRoleForThorInternalDevPolicy','arn:aws:iam::aws:policy/AWSLambdaReadOnlyAccess','arn:aws:iam::aws:policy/AmazonLaunchWizardFullaccess','arn:aws:iam::aws:policy/TagGovernancePolicy','arn:aws:iam::aws:policy/AWSSchemasServiceRolePolicy','arn:aws:iam::aws:policy/AWSElasticBeanstalkReadOnlyAccess','arn:aws:iam::aws:policy/AWSBackupOperatorPolicy','arn:aws:iam::aws:policy/AmazonEC2ReportsAccess','arn:aws:iam::aws:policy/TagPoliciesServiceRolePolicy','arn:aws:iam::aws:policy/AWS_Config_Role','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdReadOnlyAccess','arn:aws:iam::aws:policy/AmazonConnectFullAccess','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceFullAccess'] <<Deprecated Managed IAM Policy in use>>
    }
}

rule IAM_User_Policies when %iam_users !empty {
    when %iam_users.Properties.Policies exists {
        %iam_users.Properties.Policies is_list
        !%iam_users.Properties.Policies[*] IN ['arn:aws:iam::aws:policy/AmazonKendraFullAccess','arn:aws:iam::aws:policy/AmazonSageMakerFullAccess','arn:aws:iam::aws:policy/AWSLambdaReplicatorInternal','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceEventsRole','arn:aws:iam::aws:policy/AmazonElasticMapReduceFullAccess','arn:aws:iam::aws:policy/AWSDeepRacerServiceRolePolicy','arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS','arn:aws:iam::aws:policy/NeptuneConsoleFullAccess','arn:aws:iam::aws:policy/NeptuneFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksRole','arn:aws:iam::aws:policy/AWSBatchFullAccess','arn:aws:iam::aws:policy/AmazonApplicationWizardFullaccess','arn:aws:iam::aws:policy/ServerMigrationServiceRole','arn:aws:iam::aws:policy/AmazonBraketFullAccess','arn:aws:iam::aws:policy/AmazonLexFullAccess','arn:aws:iam::aws:policy/AWSDataPipelineRole','arn:aws:iam::aws:policy/AWSMarketplaceImageBuildFullAccess','arn:aws:iam::aws:policy/PowerUserAccess','arn:aws:iam::aws:policy/AWSTransferConsoleFullAccess','arn:aws:iam::aws:policy/AWSLambdaFullAccess','arn:aws:iam::aws:policy/AmazonElasticFileSystemServiceRolePolicy','arn:aws:iam::aws:policy/AmazonEventBridgeFullAccess','arn:aws:iam::aws:policy/AWSServiceRoleForSMS','arn:aws:iam::aws:policy/AmazonEMRServicePolicy_v2','arn:aws:iam::aws:policy/AmazonECS_FullAccess','arn:aws:iam::aws:policy/BatchServiceRolePolicy','arn:aws:iam::aws:policy/AmazonDynamoDBFullAccesswithDataPipeline','arn:aws:iam::aws:policy/AWSCodePipeline_FullAccess','arn:aws:iam::aws:policy/AWSThinkboxDeadlineSpotEventPluginAdminPolicy','arn:aws:iam::aws:policy/AdministratorAccess-Amplify','arn:aws:iam::aws:policy/AWSIoTDeviceDefenderEnableIoTLoggingMitigationAction','arn:aws:iam::aws:policy/AmazonHealthLakeFullAccess','arn:aws:iam::aws:policy/AWSEC2FleetServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupAdminPolicy','arn:aws:iam::aws:policy/AWSApplicationMigrationEC2Access','arn:aws:iam::aws:policy/ApplicationDiscoveryServiceContinuousExportServiceRolePolicy','arn:aws:iam::aws:policy/CloudFormationStackSetsOrgMemberServiceRolePolicy','arn:aws:iam::aws:policy/AWSServiceCatalogAdminFullAccess','arn:aws:iam::aws:policy/AmazonPersonalizeFullAccess','arn:aws:iam::aws:policy/AWSIoTDeviceTesterForGreengrassFullAccess','arn:aws:iam::aws:policy/SystemAdministrator','arn:aws:iam::aws:policy/AWSStepFunctionsConsoleFullAccess','arn:aws:iam::aws:policy/AWSOpsWorks_FullAccess','arn:aws:iam::aws:policy/AWSMarketplaceFullAccess','arn:aws:iam::aws:policy/AWSConfigMultiAccountSetupPolicy','arn:aws:iam::aws:policy/AutoScalingServiceRolePolicy','arn:aws:iam::aws:policy/AmazonFraudDetectorFullAccessPolicy','arn:aws:iam::aws:policy/AWSIoTDeviceTesterForFreeRTOSFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI','arn:aws:iam::aws:policy/AWSServiceRoleForGammaInternalAmazonEKSNodegroup','arn:aws:iam::aws:policy/DatabaseAdministrator','arn:aws:iam::aws:policy/AWSCloudTrailFullAccess','arn:aws:iam::aws:policy/NetworkAdministrator','arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk','arn:aws:iam::aws:policy/AWSMarketplaceSellerProductsFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksFullAccess','arn:aws:iam::aws:policy/AWSCodeDeployRoleForECSLimited','arn:aws:iam::aws:policy/AmazonEC2SpotFleetRole','arn:aws:iam::aws:policy/AWSCodeStarServiceRole','arn:aws:iam::aws:policy/AWSElasticBeanstalkFullAccess','arn:aws:iam::aws:policy/AWSTransferFullAccess','arn:aws:iam::aws:policy/AWSEC2SpotFleetServiceRolePolicy','arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesServiceRolePolicy','arn:aws:iam::aws:policy/CloudWatchSyntheticsFullAccess','arn:aws:iam::aws:policy/AWSB9InternalServicePolicy','arn:aws:iam::aws:policy/AmazonESCognitoAccess','arn:aws:iam::aws:policy/AWSDataPipeline_PowerUser','arn:aws:iam::aws:policy/AmazonInspectorFullAccess','arn:aws:iam::aws:policy/AWSControlTowerServiceRolePolicy','arn:aws:iam::aws:policy/EC2FleetTimeShiftableServiceRolePolicy','arn:aws:iam::aws:policy/AmazonKinesisAnalyticsFullAccess','arn:aws:iam::aws:policy/IAMFullAccess','arn:aws:iam::aws:policy/AWSElasticBeanstalkRoleCore','arn:aws:iam::aws:policy/AWSElasticBeanstalkService','arn:aws:iam::aws:policy/AmazonSSMServiceRolePolicy','arn:aws:iam::aws:policy/DataScientist','arn:aws:iam::aws:policy/AWSElementalMediaConvertFullAccess','arn:aws:iam::aws:policy/AwsGlueDataBrewFullAccessPolicy','arn:aws:iam::aws:policy/AWSServiceRoleForImageBuilder','arn:aws:iam::aws:policy/AmazonForecastFullAccess','arn:aws:iam::aws:policy/AWSIoTSiteWiseConsoleFullAccess','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdFullAccess','arn:aws:iam::aws:policy/AmazonElasticTranscoder_FullAccess','arn:aws:iam::aws:policy/AmazonAugmentedAIFullAccess','arn:aws:iam::aws:policy/AWSDataSyncFullAccess','arn:aws:iam::aws:policy/AmazonSageMakerAdmin-ServiceCatalogProductsServiceRolePolicy','arn:aws:iam::aws:policy/AWSGlueConsoleSageMakerNotebookFullAccess','arn:aws:iam::aws:policy/AmazonLaunchWizardFullaccess','arn:aws:iam::aws:policy/AWSServiceRoleForAmazonEKSNodegroup','arn:aws:iam::aws:policy/AWSDataPipeline_FullAccess','arn:aws:iam::aws:policy/ConfigConformsServiceRolePolicy','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI_OnPremises','arn:aws:iam::aws:policy/AWSLambdaReplicator','arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy','arn:aws:iam::aws:policy/AWSImageBuilderFullAccess','arn:aws:iam::aws:policy/AdministratorAccess','arn:aws:iam::aws:policy/AWSLicenseManagerMasterAccountRolePolicy','arn:aws:iam::aws:policy/AWSDeepRacerCloudFormationAccessPolicy','arn:aws:iam::aws:policy/ServerMigration_ServiceRole','arn:aws:iam::aws:policy/AWSOpsWorksCMServiceRole','arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess','arn:aws:iam::aws:policy/AWSConfigRemediationServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupOperatorPolicy','arn:aws:iam::aws:policy/AWSMarketplaceSellerFullAccess','arn:aws:iam::aws:policy/AWSCodePipelineFullAccess','arn:aws:iam::aws:policy/AmazonAppStreamFullAccess','arn:aws:iam::aws:policy/AWSSSOServiceRolePolicy','arn:aws:iam::aws:policy/AWSEC2SpotServiceRolePolicy','arn:aws:iam::aws:policy/AmazonLookoutMetricsFullAccess','arn:aws:iam::aws:policy/AWSApplicationAutoscalingRDSClusterPolicy','arn:aws:iam::aws:policy/AmazonLookoutEquipmentFullAccess','arn:aws:iam::aws:policy/AWSBatchServiceRole','arn:aws:iam::aws:policy/AWSSystemsManagerChangeManagementServicePolicy','arn:aws:iam::aws:policy/AWSRoboMakerServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupOperatorAccess','arn:aws:iam::aws:policy/AWSRoboMakerServicePolicy','arn:aws:iam::aws:policy/AWSApplicationMigrationServiceRolePolicy','arn:aws:iam::aws:policy/AWSSSOMasterAccountAdministrator','arn:aws:iam::aws:policy/AmazonElasticMapReduceRole','arn:aws:iam::aws:policy/AWSGrafanaAccountAdministrator','arn:aws:iam::aws:policy/CloudWatchEventsFullAccess','arn:aws:iam::aws:policy/AmazonEC2SpotFleetTaggingRole','arn:aws:iam::aws:policy/ServerMigrationServiceLaunchRole','arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess','arn:aws:iam::aws:policy/AWSThinkboxDeadlineResourceTrackerAdminPolicy','arn:aws:iam::aws:policy/AWSPanoramaServiceRolePolicy','arn:aws:iam::aws:policy/AmazonMSKFullAccess','arn:aws:iam::aws:policy/AWSBudgetsActionsWithAWSResourceControlAccess','arn:aws:iam::aws:policy/AWSProtonFullAccess','arn:aws:iam::aws:policy/AWSIQPermissionServiceRolePolicy','arn:aws:iam::aws:policy/AmazonSageMakerEdgeDeviceFleetPolicy','arn:aws:iam::aws:policy/AmazonLaunchWizard_Fullaccess','arn:aws:iam::aws:policy/AmazonConnectFullAccess','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceFullAccess','arn:aws:iam::aws:policy/AWSCloud9ServiceRolePolicy','arn:aws:iam::aws:policy/AmazonWorkMailFullAccess','arn:aws:iam::aws:policy/AmazonAugmentedAIIntegratedAPIAccess','arn:aws:iam::aws:policy/AmazonEMRFullAccessPolicy_v2','arn:aws:iam::aws:policy/AWSThinkboxAWSPortalAdminPolicy','arn:aws:iam::aws:policy/AWSLambda_FullAccess','arn:aws:iam::aws:policy/AWSBackupFullAccess','arn:aws:iam::aws:policy/AWSAppSyncAdministrator','arn:aws:iam::aws:policy/AWSDeepLensServiceRolePolicy','arn:aws:iam::aws:policy/AWSCloudTrail_FullAccess'] <<Managed IAM Policy has possible privilege escalation>>
        !%iam_users.Properties.Policies[*] IN ['arn:aws:iam::aws:policy/ServiceCatalogAdminReadOnlyAccess','arn:aws:iam::aws:policy/AmazonEverestServicePolicy','arn:aws:iam::aws:policy/AWSLambdaReplicatorInternal','arn:aws:iam::aws:policy/AWSOpsWorksRole','arn:aws:iam::aws:policy/AmazonEC2RolePolicyForApplicationWizard','arn:aws:iam::aws:policy/AmazonApplicationWizardFullaccess','arn:aws:iam::aws:policy/ServerMigrationServiceRole','arn:aws:iam::aws:policy/AWSLambdaFullAccess','arn:aws:iam::aws:policy/AmazonMachineLearningRoleforRedshiftDataSourceV2','arn:aws:iam::aws:policy/AWSBackupAdminPolicy','arn:aws:iam::aws:policy/AmazonMachineLearningRoleforRedshiftDataSource','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI','arn:aws:iam::aws:policy/AWSCodeArtifactReadOnlyAccess.json','arn:aws:iam::aws:policy/AWSServiceRoleForGammaInternalAmazonEKSNodegroup','arn:aws:iam::aws:policy/AWSCloudTrailFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksFullAccess','arn:aws:iam::aws:policy/AmazonEC2SpotFleetRole','arn:aws:iam::aws:policy/AWSServiceRoleForCodeGuruProfiler','arn:aws:iam::aws:policy/AWSElasticBeanstalkFullAccess','arn:aws:iam::aws:policy/CheesepuffsServiceRolePolicy','arn:aws:iam::aws:policy/AWSB9InternalServicePolicy','arn:aws:iam::aws:policy/AWSRoboMakerFullAccess','arn:aws:iam::aws:policy/ServiceCatalogEndUserAccess','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdFullAccess','arn:aws:iam::aws:policy/AWSServiceRoleForThorInternalDevPolicy','arn:aws:iam::aws:policy/AWSLambdaReadOnlyAccess','arn:aws:iam::aws:policy/AmazonLaunchWizardFullaccess','arn:aws:iam::aws:policy/TagGovernancePolicy','arn:aws:iam::aws:policy/AWSSchemasServiceRolePolicy','arn:aws:iam::aws:policy/AWSElasticBeanstalkReadOnlyAccess','arn:aws:iam::aws:policy/AWSBackupOperatorPolicy','arn:aws:iam::aws:policy/AmazonEC2ReportsAccess','arn:aws:iam::aws:policy/TagPoliciesServiceRolePolicy','arn:aws:iam::aws:policy/AWS_Config_Role','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdReadOnlyAccess','arn:aws:iam::aws:policy/AmazonConnectFullAccess','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceFullAccess'] <<Deprecated Managed IAM Policy in use>>
    }
}

rule IAM_Group_Policies when %iam_groups !empty {
    when %iam_groups.Properties.Policies exists {
        %iam_groups.Properties.Policies is_list
        !%iam_groups.Properties.Policies[*] IN ['arn:aws:iam::aws:policy/AmazonKendraFullAccess','arn:aws:iam::aws:policy/AmazonSageMakerFullAccess','arn:aws:iam::aws:policy/AWSLambdaReplicatorInternal','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceEventsRole','arn:aws:iam::aws:policy/AmazonElasticMapReduceFullAccess','arn:aws:iam::aws:policy/AWSDeepRacerServiceRolePolicy','arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS','arn:aws:iam::aws:policy/NeptuneConsoleFullAccess','arn:aws:iam::aws:policy/NeptuneFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksRole','arn:aws:iam::aws:policy/AWSBatchFullAccess','arn:aws:iam::aws:policy/AmazonApplicationWizardFullaccess','arn:aws:iam::aws:policy/ServerMigrationServiceRole','arn:aws:iam::aws:policy/AmazonBraketFullAccess','arn:aws:iam::aws:policy/AmazonLexFullAccess','arn:aws:iam::aws:policy/AWSDataPipelineRole','arn:aws:iam::aws:policy/AWSMarketplaceImageBuildFullAccess','arn:aws:iam::aws:policy/PowerUserAccess','arn:aws:iam::aws:policy/AWSTransferConsoleFullAccess','arn:aws:iam::aws:policy/AWSLambdaFullAccess','arn:aws:iam::aws:policy/AmazonElasticFileSystemServiceRolePolicy','arn:aws:iam::aws:policy/AmazonEventBridgeFullAccess','arn:aws:iam::aws:policy/AWSServiceRoleForSMS','arn:aws:iam::aws:policy/AmazonEMRServicePolicy_v2','arn:aws:iam::aws:policy/AmazonECS_FullAccess','arn:aws:iam::aws:policy/BatchServiceRolePolicy','arn:aws:iam::aws:policy/AmazonDynamoDBFullAccesswithDataPipeline','arn:aws:iam::aws:policy/AWSCodePipeline_FullAccess','arn:aws:iam::aws:policy/AWSThinkboxDeadlineSpotEventPluginAdminPolicy','arn:aws:iam::aws:policy/AdministratorAccess-Amplify','arn:aws:iam::aws:policy/AWSIoTDeviceDefenderEnableIoTLoggingMitigationAction','arn:aws:iam::aws:policy/AmazonHealthLakeFullAccess','arn:aws:iam::aws:policy/AWSEC2FleetServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupAdminPolicy','arn:aws:iam::aws:policy/AWSApplicationMigrationEC2Access','arn:aws:iam::aws:policy/ApplicationDiscoveryServiceContinuousExportServiceRolePolicy','arn:aws:iam::aws:policy/CloudFormationStackSetsOrgMemberServiceRolePolicy','arn:aws:iam::aws:policy/AWSServiceCatalogAdminFullAccess','arn:aws:iam::aws:policy/AmazonPersonalizeFullAccess','arn:aws:iam::aws:policy/AWSIoTDeviceTesterForGreengrassFullAccess','arn:aws:iam::aws:policy/SystemAdministrator','arn:aws:iam::aws:policy/AWSStepFunctionsConsoleFullAccess','arn:aws:iam::aws:policy/AWSOpsWorks_FullAccess','arn:aws:iam::aws:policy/AWSMarketplaceFullAccess','arn:aws:iam::aws:policy/AWSConfigMultiAccountSetupPolicy','arn:aws:iam::aws:policy/AutoScalingServiceRolePolicy','arn:aws:iam::aws:policy/AmazonFraudDetectorFullAccessPolicy','arn:aws:iam::aws:policy/AWSIoTDeviceTesterForFreeRTOSFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI','arn:aws:iam::aws:policy/AWSServiceRoleForGammaInternalAmazonEKSNodegroup','arn:aws:iam::aws:policy/DatabaseAdministrator','arn:aws:iam::aws:policy/AWSCloudTrailFullAccess','arn:aws:iam::aws:policy/NetworkAdministrator','arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk','arn:aws:iam::aws:policy/AWSMarketplaceSellerProductsFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksFullAccess','arn:aws:iam::aws:policy/AWSCodeDeployRoleForECSLimited','arn:aws:iam::aws:policy/AmazonEC2SpotFleetRole','arn:aws:iam::aws:policy/AWSCodeStarServiceRole','arn:aws:iam::aws:policy/AWSElasticBeanstalkFullAccess','arn:aws:iam::aws:policy/AWSTransferFullAccess','arn:aws:iam::aws:policy/AWSEC2SpotFleetServiceRolePolicy','arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesServiceRolePolicy','arn:aws:iam::aws:policy/CloudWatchSyntheticsFullAccess','arn:aws:iam::aws:policy/AWSB9InternalServicePolicy','arn:aws:iam::aws:policy/AmazonESCognitoAccess','arn:aws:iam::aws:policy/AWSDataPipeline_PowerUser','arn:aws:iam::aws:policy/AmazonInspectorFullAccess','arn:aws:iam::aws:policy/AWSControlTowerServiceRolePolicy','arn:aws:iam::aws:policy/EC2FleetTimeShiftableServiceRolePolicy','arn:aws:iam::aws:policy/AmazonKinesisAnalyticsFullAccess','arn:aws:iam::aws:policy/IAMFullAccess','arn:aws:iam::aws:policy/AWSElasticBeanstalkRoleCore','arn:aws:iam::aws:policy/AWSElasticBeanstalkService','arn:aws:iam::aws:policy/AmazonSSMServiceRolePolicy','arn:aws:iam::aws:policy/DataScientist','arn:aws:iam::aws:policy/AWSElementalMediaConvertFullAccess','arn:aws:iam::aws:policy/AwsGlueDataBrewFullAccessPolicy','arn:aws:iam::aws:policy/AWSServiceRoleForImageBuilder','arn:aws:iam::aws:policy/AmazonForecastFullAccess','arn:aws:iam::aws:policy/AWSIoTSiteWiseConsoleFullAccess','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdFullAccess','arn:aws:iam::aws:policy/AmazonElasticTranscoder_FullAccess','arn:aws:iam::aws:policy/AmazonAugmentedAIFullAccess','arn:aws:iam::aws:policy/AWSDataSyncFullAccess','arn:aws:iam::aws:policy/AmazonSageMakerAdmin-ServiceCatalogProductsServiceRolePolicy','arn:aws:iam::aws:policy/AWSGlueConsoleSageMakerNotebookFullAccess','arn:aws:iam::aws:policy/AmazonLaunchWizardFullaccess','arn:aws:iam::aws:policy/AWSServiceRoleForAmazonEKSNodegroup','arn:aws:iam::aws:policy/AWSDataPipeline_FullAccess','arn:aws:iam::aws:policy/ConfigConformsServiceRolePolicy','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI_OnPremises','arn:aws:iam::aws:policy/AWSLambdaReplicator','arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy','arn:aws:iam::aws:policy/AWSImageBuilderFullAccess','arn:aws:iam::aws:policy/AdministratorAccess','arn:aws:iam::aws:policy/AWSLicenseManagerMasterAccountRolePolicy','arn:aws:iam::aws:policy/AWSDeepRacerCloudFormationAccessPolicy','arn:aws:iam::aws:policy/ServerMigration_ServiceRole','arn:aws:iam::aws:policy/AWSOpsWorksCMServiceRole','arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess','arn:aws:iam::aws:policy/AWSConfigRemediationServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupOperatorPolicy','arn:aws:iam::aws:policy/AWSMarketplaceSellerFullAccess','arn:aws:iam::aws:policy/AWSCodePipelineFullAccess','arn:aws:iam::aws:policy/AmazonAppStreamFullAccess','arn:aws:iam::aws:policy/AWSSSOServiceRolePolicy','arn:aws:iam::aws:policy/AWSEC2SpotServiceRolePolicy','arn:aws:iam::aws:policy/AmazonLookoutMetricsFullAccess','arn:aws:iam::aws:policy/AWSApplicationAutoscalingRDSClusterPolicy','arn:aws:iam::aws:policy/AmazonLookoutEquipmentFullAccess','arn:aws:iam::aws:policy/AWSBatchServiceRole','arn:aws:iam::aws:policy/AWSSystemsManagerChangeManagementServicePolicy','arn:aws:iam::aws:policy/AWSRoboMakerServiceRolePolicy','arn:aws:iam::aws:policy/AWSBackupOperatorAccess','arn:aws:iam::aws:policy/AWSRoboMakerServicePolicy','arn:aws:iam::aws:policy/AWSApplicationMigrationServiceRolePolicy','arn:aws:iam::aws:policy/AWSSSOMasterAccountAdministrator','arn:aws:iam::aws:policy/AmazonElasticMapReduceRole','arn:aws:iam::aws:policy/AWSGrafanaAccountAdministrator','arn:aws:iam::aws:policy/CloudWatchEventsFullAccess','arn:aws:iam::aws:policy/AmazonEC2SpotFleetTaggingRole','arn:aws:iam::aws:policy/ServerMigrationServiceLaunchRole','arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess','arn:aws:iam::aws:policy/AWSThinkboxDeadlineResourceTrackerAdminPolicy','arn:aws:iam::aws:policy/AWSPanoramaServiceRolePolicy','arn:aws:iam::aws:policy/AmazonMSKFullAccess','arn:aws:iam::aws:policy/AWSBudgetsActionsWithAWSResourceControlAccess','arn:aws:iam::aws:policy/AWSProtonFullAccess','arn:aws:iam::aws:policy/AWSIQPermissionServiceRolePolicy','arn:aws:iam::aws:policy/AmazonSageMakerEdgeDeviceFleetPolicy','arn:aws:iam::aws:policy/AmazonLaunchWizard_Fullaccess','arn:aws:iam::aws:policy/AmazonConnectFullAccess','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceFullAccess','arn:aws:iam::aws:policy/AWSCloud9ServiceRolePolicy','arn:aws:iam::aws:policy/AmazonWorkMailFullAccess','arn:aws:iam::aws:policy/AmazonAugmentedAIIntegratedAPIAccess','arn:aws:iam::aws:policy/AmazonEMRFullAccessPolicy_v2','arn:aws:iam::aws:policy/AWSThinkboxAWSPortalAdminPolicy','arn:aws:iam::aws:policy/AWSLambda_FullAccess','arn:aws:iam::aws:policy/AWSBackupFullAccess','arn:aws:iam::aws:policy/AWSAppSyncAdministrator','arn:aws:iam::aws:policy/AWSDeepLensServiceRolePolicy','arn:aws:iam::aws:policy/AWSCloudTrail_FullAccess'] <<Managed IAM Policy has possible privilege escalation>>
        !%iam_groups.Properties.Policies[*] IN ['arn:aws:iam::aws:policy/ServiceCatalogAdminReadOnlyAccess','arn:aws:iam::aws:policy/AmazonEverestServicePolicy','arn:aws:iam::aws:policy/AWSLambdaReplicatorInternal','arn:aws:iam::aws:policy/AWSOpsWorksRole','arn:aws:iam::aws:policy/AmazonEC2RolePolicyForApplicationWizard','arn:aws:iam::aws:policy/AmazonApplicationWizardFullaccess','arn:aws:iam::aws:policy/ServerMigrationServiceRole','arn:aws:iam::aws:policy/AWSLambdaFullAccess','arn:aws:iam::aws:policy/AmazonMachineLearningRoleforRedshiftDataSourceV2','arn:aws:iam::aws:policy/AWSBackupAdminPolicy','arn:aws:iam::aws:policy/AmazonMachineLearningRoleforRedshiftDataSource','arn:aws:iam::aws:policy/AWSOpsWorksRegisterCLI','arn:aws:iam::aws:policy/AWSCodeArtifactReadOnlyAccess.json','arn:aws:iam::aws:policy/AWSServiceRoleForGammaInternalAmazonEKSNodegroup','arn:aws:iam::aws:policy/AWSCloudTrailFullAccess','arn:aws:iam::aws:policy/AWSOpsWorksFullAccess','arn:aws:iam::aws:policy/AmazonEC2SpotFleetRole','arn:aws:iam::aws:policy/AWSServiceRoleForCodeGuruProfiler','arn:aws:iam::aws:policy/AWSElasticBeanstalkFullAccess','arn:aws:iam::aws:policy/CheesepuffsServiceRolePolicy','arn:aws:iam::aws:policy/AWSB9InternalServicePolicy','arn:aws:iam::aws:policy/AWSRoboMakerFullAccess','arn:aws:iam::aws:policy/ServiceCatalogEndUserAccess','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdFullAccess','arn:aws:iam::aws:policy/AWSServiceRoleForThorInternalDevPolicy','arn:aws:iam::aws:policy/AWSLambdaReadOnlyAccess','arn:aws:iam::aws:policy/AmazonLaunchWizardFullaccess','arn:aws:iam::aws:policy/TagGovernancePolicy','arn:aws:iam::aws:policy/AWSSchemasServiceRolePolicy','arn:aws:iam::aws:policy/AWSElasticBeanstalkReadOnlyAccess','arn:aws:iam::aws:policy/AWSBackupOperatorPolicy','arn:aws:iam::aws:policy/AmazonEC2ReportsAccess','arn:aws:iam::aws:policy/TagPoliciesServiceRolePolicy','arn:aws:iam::aws:policy/AWS_Config_Role','arn:aws:iam::aws:policy/AmazonMechanicalTurkCrowdReadOnlyAccess','arn:aws:iam::aws:policy/AmazonConnectFullAccess','arn:aws:iam::aws:policy/AmazonEC2ContainerServiceFullAccess'] <<Deprecated Managed IAM Policy in use>>
    }
}
